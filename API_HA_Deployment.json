{
    "Description": "It will create HA Env. using ASC, ELB, SG, Alarm, Ec2, Iam and other reuired things.",
    "Parameters": {
        "OperatorEMail": {
            "Description": "EMail address to notify if there are any scaling operations",
            "Type": "String",
            "AllowedPattern": "([a-zA-Z0-9_\\-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([a-zA-Z0-9\\-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)",
            "ConstraintDescription": "must be a valid email address."
        },
        "CPUPolicyTargetValue": {
            "Type": "String"
        },
        "MaxSizeASG": {
            "Description": "Enter the Max Size for the ASG",
            "Type": "String"
        },
        "MinSizeASG": {
            "Description": "Enter the Min Size for the ASG",
            "Type": "String"
        },
        "DesiredCapacityASG": {
            "Description": "Enter the desired capacity for the ASG",
            "Type": "String"
        },
        "VPC": {
            "Description": "Please Select the VPCID",
            "Type": "AWS::EC2::VPC::Id",
            "Default": "vpc-0ddb8744ff3cb1dec"
        },
        "PvtSubnets": {
            "Description": "List the Subnet Ids of the instances",
            "Type": "List<AWS::EC2::Subnet::Id>"
        },
        "LoadBalancerArn": {
            "Description": "LoadBalancer ARN",
            "Type": "String",
            "Default": "arn:aws:elasticloadbalancing:ap-south-1:925557267655:loadbalancer/app/clovia-prod-web-alb/a5211e61edfe19bb"
        },
        "LoadBalancerCertificateArn": {
            "Description": "Optional Amazon Resource Name (ARN) of the certificate to associate with the load balancer.",
            "Type": "String",
            "Default": "arn:aws:acm:ap-south-1:925557267655:certificate/1de42fb7-9d11-4c8e-903e-fba506276a06"
        },
        "TargetGroupArn": {
            "Description": "TGs ARN",
            "Type": "String",
            "Default": "arn:aws:elasticloadbalancing:ap-south-1:925557267655:targetgroup/APITargetGroup/25c39f4a0df732bf"
        },
        "KeyName": {
            "Description": "EC2 instance key name",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "Ec2RootVolumeSize": {
            "Description": "RootVolumeSize minimum value in GB",
            "Type": "Number",
            "Default": "100",
            "MinValue": 100
        },
        "Roles": {
            "Description": "Enter the Role Name.",
            "Type": "String",
            "Default": "clovia-web_app-role-asg"
        },
        "InstanceType": {
            "Description": "EC2 instance type",
            "Type": "String",
            "Default": "m5.large"
        }
    },
    "Mappings": {
        "RegionMap": {
            "ap-south-1": {
                "HVM64": "ami-08282976fc92ee079"
            }
        }
    },
    "Conditions": {
        "HasLoadBalancerCertificateArn": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LoadBalancerCertificateArn"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "NotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "OperatorEMail"
                        },
                        "Protocol": "email"
                    }
                ]
            }
        },
        "InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "Roles"
                    }
                ]
            }
        },
        "AppSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Clovia compliance Instance security group",
                "GroupName": {
                    "Fn::Sub": "${AWS::StackName}-SG"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "SourceSecurityGroupId": "sg-086032fc8b6c6316d",
                        "Description": "Allowed To ELB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "SourceSecurityGroupId": "sg-06ad63dca7b525ec8",
                        "Description": "SSH allowed from Opevpn Server"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "SourceSecurityGroupId": "sg-086032fc8b6c6316d",
                        "Description": "Allowed To ELB"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "CloviaAPIProdSecurityGroup"
                    },
                    {
                        "Key": "appname",
                        "Value": "PublicApps"
                    },
                    {
                        "Key": "businessunit",
                        "Value": "Clovia"
                    },
                    {
                        "Key": "environment",
                        "Value": "Prod"
                    }
                ]
            }
        },
        

        "LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "${AWS::StackName}-launch-template"
                },
                "LaunchTemplateData": {
                    "DisableApiTermination": "True",
                    "InstanceInitiatedShutdownBehavior": "stop",
                    "ImageId": {
                        "Fn::FindInMap": [
                            "RegionMap",
                            {
                                "Ref": "AWS::Region"
                            },
                            "HVM64"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "InstanceType"
                    },
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "Monitoring": {
                        "Enabled": true
                    },
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "InstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                                "DeleteOnTermination": "true",
                                "VolumeSize": {
                                    "Ref": "Ec2RootVolumeSize"
                                }
                            }
                        }
                    ],
                    "NetworkInterfaces": [
                        {
                            "DeleteOnTermination": "true",
                            "Description": "Primary",
                            "DeviceIndex": 0,
                            "SubnetId": {
                                "Fn::Select": [
                                    0,
                                    {
                                        "Ref": "PvtSubnets"
                                    }
                                ]
                            },
                            "Groups": [
                                {
                                    "Ref": "AppSecurityGroup"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AutoScalingGroupName": "CloviaAPIscalingGroup",
                "Cooldown": 120,
                "DesiredCapacity": {
                    "Ref": "DesiredCapacityASG"
                },
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "TargetGroupARNs": [
                    {
                        "Ref": "TargetGroupArn"
                    }
                ],
                "MaxSize": {
                    "Ref": "MaxSizeASG"
                },
                "MinSize": {
                    "Ref": "MinSizeASG"
                },
                "Tags": [
                    {
                        "Key": "IName",
                        "Value": "CloviaASG",
                        "PropagateAtLaunch": "true"
                    },
                    {
                        "Key": "Name",
                        "Value": "Clovia_API-ASG",
                        "PropagateAtLaunch": "true"
                    },
                    {
                        "Key": "backup",
                        "Value": "yes:f=1d:r=7d",
                        "PropagateAtLaunch": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Prod",
                        "PropagateAtLaunch": "true"
                    }
                ],
                "VPCZoneIdentifier": {
                    "Ref": "PvtSubnets"
                },
                "NotificationConfigurations": [
                    {
                        "TopicARN": {
                            "Ref": "NotificationTopic"
                        },
                        "NotificationTypes": [
                            "autoscaling:EC2_INSTANCE_LAUNCH",
                            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
                            "autoscaling:EC2_INSTANCE_TERMINATE",
                            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                        ]
                    }
                ]
            }
        },
        "ScalingPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "EstimatedInstanceWarmup": 60,
                "PolicyType": "TargetTrackingScaling",
                "TargetTrackingConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ASGAverageCPUUtilization"
                    },
                    "TargetValue": {
                        "Ref": "CPUPolicyTargetValue"
                    }
                }
            }
        }
    },
    "Outputs": {
        "AutoscalingGroup": {
            "Description": "The newly created asg",
            "Value": {
                "Ref": "AutoScalingGroup"
            }
        },
        "LaunchTemplate": {
            "Description": "the newly created launch config",
            "Value": {
                "Ref": "LaunchTemplate"
            }
        },
        "TargetGroupArn": {
            "Description": "HTTP Target Group",
            "Value": {
                "Ref": "TargetGroupArn"
            }
        },
        "ApplicationLoadBalancer": {
            "Description": "Application Load Balancer",
            "Value": {
                "Ref": "LoadBalancerArn"
            }
        }
    },
    "AWSTemplateFormatVersion": "2010-09-09"
}